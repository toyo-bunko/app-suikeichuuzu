<!DOCTYPE html>
<html>
  <head>
    <title>Annotorious | OpenSeadragon Plugin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div>
      <div id="openseadragon" style="width: 100%; height: 600px;"></div>
    </div>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.1.0/dist/annotorious.min.css"
    />
    <script
      type="text/javascript"
      src="https://recogito.github.io/js/openseadragon/openseadragon.2.4.2.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.1.0/dist/openseadragon-annotorious.min.js"
    ></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
      function test(url){
        var result = $.ajax({
            type: 'GET',
            
            url: url,
            async: false
        }).responseJSON;
        return result;
    }

      var arg = new Object()
      url = location.search.substring(1).split('&')

      for (i = 0; url[i]; i++) {
        var k = url[i].split('=')
        const label = k[0]
        const value = decodeURIComponent(k[1])

        if(!arg[label]){
          arg[label] = []
        }
        arg[label].push(value)
      }

      const curation = test(arg.curation[0])
      
      const ids = arg.member

      const selections = curation.selections
      
      const map = {}
      
      selections.map((selection) => {
        const members = selection.members
        members.map((member) => {
          if(ids.includes(member["@id"])){
            const image = member.thumbnail.split(".tif/")[0]+".tif"
            if(!map[image]){
              map[image] = []
            }
            map[image].push({
              '@context': 'http://www.w3.org/ns/anno.jsonld',
              id: member["@id"],
              type: 'Annotation',
              body: [
                {
                  type: 'TextualBody',
                  value: member.label,
                  format: 'text/html'
                }
              ],
              target: {
                selector: {
                  type: 'FragmentSelector',
                  conformsTo: 'http://www.w3.org/TR/media-frags/',
                  value: member["@id"].split("#")[1]
                }
              }
            })
          }
        })
      })

      window.onload = function() {
        for(let image in map){

          const uri = image + "/info.json"

          var viewer = OpenSeadragon({
            id: 'openseadragon',
            prefixUrl: 'https://recogito.github.io/js/openseadragon/images/',
            tileSources: test(uri)
          })

          var anno = OpenSeadragon.Annotorious(viewer, {
            readOnly: true,
            locale: 'auto'
          })

          map[image].map((data) => {
            anno.addAnnotation(data)
          })

          break
        }
        
      }
    </script>
  </body>
</html>
