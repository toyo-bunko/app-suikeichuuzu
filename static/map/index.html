<!DOCTYPE html>
<html>
  <head>
    <title>Annotorious | OpenSeadragon Plugin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div>
      <style>
        .openseadragon-canvas {
          outline:none; 
          background-color:#f4f4f4 !important;
          border-radius:3px;
        }

        /** New style for the annotation outlines **/
        svg.a9s-annotationlayer .a9s-selection .a9s-inner,
        svg.a9s-annotationlayer .a9s-annotation .a9s-inner  {
          stroke:#1976d2;
        }
      </style>
      <div id="openseadragon" style="width: 100%; height: 100%; position: fixed;"></div>
    </div>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.1.0/dist/annotorious.min.css"
    />
    <script
      type="text/javascript"
      src="https://recogito.github.io/js/openseadragon/openseadragon.2.4.2.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.1.0/dist/openseadragon-annotorious.min.js"
    ></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
      function test(url){
        var result = $.ajax({
            type: 'GET',
            url: url,
            async: false
        }).responseJSON;
        return result;
    }

      var arg = new Object()
      url = location.search.substring(1).split('&')

      for (i = 0; url[i]; i++) {
        var k = url[i].split('=')
        const label = decodeURIComponent(k[0])
        const value = decodeURIComponent(k[1])

        if(!arg[label]){
          arg[label] = []
        }
        arg[label].push(value)
      }

      const curation = test(arg.curation[0])
      
      const ids = arg.member

      const selections = curation.selections
      
      const map = {}
      
      selections.map((selection) => {
        const members = selection.members

        members.map((member) => {

          const metadata = member.metadata

          const metadataObj = {}
          metadata.map((m) => {
            const label = m.label
            if(!metadataObj[label]){
              metadataObj[label] = []
            }
            metadataObj[label].push(m.value)
          })

          let flg = true
          
          for(let key in arg){
            const values = arg[key]
            if(key == "curation"){
              continue
            } else if(key == "q"){
              values.map((value) => {
                let flg2 = false
                for(let f in metadataObj){
                  metadataObj[f].map((v) => {
                    if(String(v).includes(value)){
                      flg2 = true
                      return
                    }
                  })
                }
                if(!flg2){
                  flg = false
                }
              })
            } else if(key.includes("q-")){
              const field = key.replace("q-", "")
              values.map((value) => {
                let flg2 = false
                if(!metadataObj[field]){
                  return
                } else {
                  metadataObj[field].map((v) => {
                    if(String(v).includes(value)){
                      flg2 = true
                      return
                    }
                  })
                }
                
                if(!flg2){
                  flg = false
                }
              })
            } else if(key.includes("fc-")){
              const field = key.replace("fc-", "")
              values.map((value) => {
                let flg2 = false
                if(!metadataObj[field]){
                  return
                } else {
                  metadataObj[field].map((v) => {
                    if(String(v) == value){
                      flg2 = true
                      return
                    }
                  })
                }
                
                if(!flg2){
                  flg = false
                }
              })
            }
          }

          if(flg){
            const image = member.thumbnail.split(".tif/")[0]+".tif"
            if(!map[image]){
              map[image] = []
            }
            map[image].push({
              '@context': 'http://www.w3.org/ns/anno.jsonld',
              id: member["@id"],
              type: 'Annotation',
              body: [
                {
                  type: 'TextualBody',
                  value: member.label,
                  format: 'text/html'
                }
              ],
              target: {
                selector: {
                  type: 'FragmentSelector',
                  conformsTo: 'http://www.w3.org/TR/media-frags/',
                  value: member["@id"].split("#")[1]
                }
              }
            })
          }
        })
      })

      window.onload = function() {
        for(let image in map){

          const uri = image + "/info.json"

          var viewer = OpenSeadragon({
            id: 'openseadragon',
            prefixUrl: 'https://recogito.github.io/js/openseadragon/images/',
            tileSources: test(uri)
          })

          var anno = OpenSeadragon.Annotorious(viewer, {
            readOnly: true,
            locale: 'auto'
          })

          map[image].map((data) => {
            anno.addAnnotation(data)
          })

          break
        }
        
      }
    </script>
  </body>
</html>
